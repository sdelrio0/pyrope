<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/utils.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/sdelrio0/pyrope.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/models.js~PyropeModel.html">PyropeModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-all">all</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-count">count</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-destroy">destroy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-findByIndex">findByIndex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-first">first</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-last">last</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-take">take</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-update">update</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-associate">associate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-dissociate">dissociate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getAssociations">getAssociations</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ddb">ddb</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ddbClient">ddbClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-decreaseCounter">decreaseCounter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-increaseCounter">increaseCounter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-updateCounter">updateCounter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-buildAction">buildAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-buildUpdateExpression">buildUpdateExpression</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-genTableDigest">genTableDigest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-iterateArrayOverPromise">iterateArrayOverPromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sha256">sha256</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/utils.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { extend, omit, mapObject, isString, isFunction } from &apos;underscore&apos;;
import crypto from &apos;crypto&apos;;

/**
 * Builds an UpdateExpression to use in &apos;params&apos; using only the provided item fields.
 *
 * It makes the assumption that the HASH key is &apos;uuid&apos; (and is excluded) and that every updated model has the attribute &apos;updatedAt&apos;
 *
 * @param {object} args The item to update in the form {uuid: &apos;123&apos;, field1: &apos;newValue&apos;, ...}
 * @param {function} fn(attrName, args) Callback function to filter the fields.
 *   The function has to return an object with the desired Name and Value in the form {name: &apos;value&apos;}
 *   If null or undefined are returned, the field is ignored.
 * @return {object} An object to be merged in params, in the form
 *   {UpdateExpression, ExpressionAttributeNames, ExpressionAttributeValues}
 */
export const buildUpdateExpression = (args, hookFn) =&gt; new Promise((resolve, reject) =&gt; {
  const mapExpression = (prevExpression, attrMap) =&gt; {
    if (attrMap) {
      const key = Object.keys(attrMap)[0];
      const val = attrMap[key];
    
      return {...prevExpression, [key]: val};
    } else {
      return prevExpression;
    }
  };
  
  const fields = omit(args, &apos;uuid&apos;);
  
  iterateArrayOverPromise(Object.keys(fields), (attrName, prevExpression) =&gt; {
    try { // hookFn is a promise
      return hookFn(attrName, args)
        .then(attrMap =&gt; mapExpression(prevExpression, attrMap))
        .catch(err =&gt; Promise.reject(`hookFn(): ${err}`));
    } catch(err) { // hookFn is a regular function
      return Promise.resolve(mapExpression(prevExpression, hookFn(attrName, args)))
    }
  }, true).then(expression =&gt; {
    if(!expression.updatedAt) expression.updatedAt = Number(new Date().getTime()); // Set updatedAt field in case it wasn&apos;t provided
  
    let updateExpressionArr = [];
    let updateExpression;
    let expressionAttributeNames = {};
    let expressionAttributeValues = {};
  
    mapObject(expression, (val, key) =&gt; {
      updateExpressionArr.push(`#${key} = :${key}`);
      expressionAttributeNames[`#${key}`] = key;
      expressionAttributeValues[`:${key}`] = val;
    });
  
    updateExpression = `SET ${updateExpressionArr.join(&apos;, &apos;)}`;
  
    resolve({
      UpdateExpression: updateExpression,
      ExpressionAttributeNames: expressionAttributeNames,
      ExpressionAttributeValues: expressionAttributeValues,
    });
    
  }).catch(err =&gt; reject(`buildUpdateExpression(): ${err}`));
});

export const sha256 = (data) =&gt; {
  if(!data || !isString(data)) throw new Error(`sha256(): Invalid value for data`);
  
  const hash = crypto.createHash(&apos;sha256&apos;);
  
  hash.update(data);
  
  return hash.digest(&apos;hex&apos;);
};

export const genTableDigest = ( tableName ) =&gt; (sha256(tableName)+&apos;.&apos;+tableName);

/**
 * Iterates a promise over each element of the array
 * If chaining is true, the resolved value is passed
 *  on to the promise of the following iteration
 *
 * Promise should have the signature (arg, prev)
 *  Where arg is the current iterated item from the array
 *  and prev is the previously resolved value.
 *
 * @param {Array} arr The array to iterate
 * @param {Function} fn The promise to use
 * @param {Boolean} chained Optional. Pass the resolved value on to the following iteration?
 * @result The resolved value of the last iteration. undefined if chained is false.
 * @todo: Substitute with Promise.each() ?
 * @todo: Check for possible bug when fn doesn&apos;t return a Promise
 */
export const iterateArrayOverPromise = (arr, fn, chained = false, index = 0, value = undefined) =&gt; {
  if(index === arr.length) return Promise.resolve(value);
  
  return (chained ? fn(arr[index], value, index) : fn(arr[index], index))
    .then(res =&gt; iterateArrayOverPromise(arr, fn, chained, ++index, chained ? res : undefined))
    .catch(err =&gt; Promise.reject(`iterateArrayOverPromise(): ${err}`));
};

export const buildAction = (type, prevUuidAction, prevItemAction, index) =&gt; {
  const key = Object.keys(index)[0];
  const val = index[key];
  
  let action = extend({}, prevItemAction, prevUuidAction);
  
  if(!action[type]) action[type] = {};
  if(!action[type][key]) action[type][key] = [];
  
  action[type][key].push(val);
  
  return action;
};</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
